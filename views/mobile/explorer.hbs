{{#extend "mStyle"}}
    <link rel="stylesheet" href="/common/css/swiper.min.css">
    <style>
        html {
            color: #000;
            background: #fff;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%
        }

        html * {
            outline: 0;
            -webkit-text-size-adjust: none;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0)
        }

        html, body {
            font-family: sans-serif
        }

        body, div, dl, dt, dd, ul, ol, li, h1, h2, h3, h4, h5, h6, pre, code, form, fieldset, legend, input, textarea, p, blockquote, th, td, hr, button, article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {
            margin: 0;
            padding: 0
        }

        input, select, textarea {
            font-size: 100%
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset, img {
            border: 0
        }

        abbr, acronym {
            border: 0;
            font-variant: normal
        }

        del {
            text-decoration: line-through
        }

        address, caption, cite, code, dfn, em, th, var {
            font-style: normal;
            font-weight: 500
        }

        ol, ul {
            list-style: none
        }

        caption, th {
            text-align: left
        }

        h1, h2, h3, h4, h5, h6 {
            font-size: 100%;
            font-weight: 500
        }

        q:before, q:after {
            content: ''
        }

        sub, sup {
            font-size: 75%;
            line-height: 0;
            position: relative;
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a:hover {
            text-decoration: underline
        }

        ins, a {
            text-decoration: none
        }
    </style>
    <style>
        html, body {
            position: relative;
            height: 100%;
        }

        body {
            background: #fff;
            font-size: 14px;
            color: #000;
            margin: 0;
            padding: 0;
        }

        .swiper-container {
            height: 100%;
            position: relative;
            moz-user-select: -moz-none;
            -moz-user-select: none;
            -o-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;

        }

        .swiper-wrapper {
            position: relative;
            z-index: 2;
            background: #fff;
        }

        .swiper-slide {
            /* Center slide text vertically */
            display: -webkit-box;
            display: -ms-flexbox;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-align: center;
            -ms-flex-align: center;
            -webkit-align-items: center;
            align-items: center;
            flex-direction: column;
            flex-shrink: 0;
            margin: 0.5rem 0;
        }



        .swiper-container-horizontal > .swiper-pagination-bullets {
            top: 0;
            bottom: auto;
            background: #fff;
            border-bottom: 1px solid #d1d1d1;
        }

        .swiper-pagination-bullet {
            width: auto;
            height: auto;
            opacity: 0.6;
            background: none;
            padding: 0.2rem 0.4rem 0.15rem;
            -webkit-border-radius: 0;
            -moz-border-radius: 0;
            border-radius: 0;
            font-size: 0.35rem;
        }

        .swiper-pagination-bullet-active {
            border-bottom: 6px solid #007aff;
            opacity: 1;
        }

        .swiper-lazy-preloader {
            text-align: center;
            width: 1rem;
            height: 1rem;
            -webkit-animation: none;
            -o-animation: none;
            animation: none;
            display: block;
        }

        .swiper-lazy-preloader:after {
            background: none;
        }



        .swiper-container-h {
            border-bottom: 1.2rem solid #222729;
            box-sizing: border-box;
        }

        .refresh {
            text-align: center;
            width: 100%;
            height: 0;
            transform: translate3d(0, -1rem, 0)
        }

        .refresh span {
            background: #fff;
            -webkit-border-radius: 6px;
            -moz-border-radius: 6px;
            border-radius: 6px;
            opacity: .6
        }

        .refresh .refresh-icon {
            position: fixed;
            top: -0.8rem;
            left: 50%;
            margin-left: -0.4rem;
            z-index: 10;
            width: .8rem;
            height: .8rem;
            box-sizing: border-box;
            border-radius: 100%;
            border: 3px solid #6db233;
            border-bottom-color: transparent;
            display: block;
            background: #fff;
            transform-origin: center center 0
        }

        .anim {
            animation: loader 1s infinite linear
        }

        @keyframes loader {
            0% {
                transform: rotate(0deg)
            }
            100% {
                transform: rotate(359deg)
            }
        }

        .loader {
            position: absolute;
            left: 50%;
            bottom: .8rem;
            z-index: 1;
            display: none;
            text-align: center
        }

        .loader span {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            position: absolute;
            left: 50%;
            margin-left: -10px;
            -webkit-animation: 3s infinite linear;
            -moz-animation: 3s infinite linear;
            -o-animation: 3s infinite linear
        }

        .editAlbumsTitle.edit {
            width: 80%;
            color: #122b68;
            overflow: hidden;
            font-size: .3rem
        }

        .loader span:nth-child(1) {
            background: #e84c3d;
            -webkit-animation: kiri 1.2s infinite linear;
            -moz-animation: kiri 1.2s infinite linear;
            -o-animation: kiri 1.2s infinite linear
        }

        .loader span:nth-child(2) {
            background: #f1c40f;
            z-index: 100
        }

        .loader span:nth-child(3) {
            background: #2fcc71;
            -webkit-animation: kanan 1.2s infinite linear;
            -moz-animation: kanan 1.2s infinite linear;
            -o-animation: kanan 1.2s infinite linear
        }

        @-webkit-keyframes kanan {
            0% {
                -webkit-transform: translateX(20px)
            }
            50% {
                -webkit-transform: translateX(-20px)
            }
            100% {
                -webkit-transform: translateX(20px);
                z-index: 200
            }
        }

        @-moz-keyframes kanan {
            0% {
                -moz-transform: translateX(20px)
            }
            50% {
                -moz-transform: translateX(-20px)
            }
            100% {
                -moz-transform: translateX(20px);
                z-index: 200
            }
        }

        @-o-keyframes kanan {
            0% {
                -o-transform: translateX(20px)
            }
            50% {
                -o-transform: translateX(-20px)
            }
            100% {
                -o-transform: translateX(20px);
                z-index: 200
            }
        }

        @-webkit-keyframes kiri {
            0% {
                -webkit-transform: translateX(-20px);
                z-index: 200
            }
            50% {
                -webkit-transform: translateX(20px)
            }
            100% {
                -webkit-transform: translateX(-20px)
            }
        }

        @-moz-keyframes kiri {
            0% {
                -moz-transform: translateX(-20px);
                z-index: 200
            }
            50% {
                -moz-transform: translateX(20px)
            }
            100% {
                -moz-transform: translateX(-20px)
            }
        }

        @-o-keyframes kiri {
            0% {
                -o-transform: translateX(-20px);
                z-index: 200
            }
            50% {
                -o-transform: translateX(20px)
            }
            100% {
                -o-transform: translateX(-20px)
            }
        }
        .box{
            width: 33.3%;
            display: block;
            position: relative;

        }
        .box img{
            width: 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-size:cover;
            display: block;

        }
        .swiper-slide{
            flex-direction: row;
            flex-wrap: wrap;
            margin: 0;
        }
    </style>
{{/extend}}

<div class="swiper-container swiper-container-v">
    <div class="swiper-wrapper" ajax="true" count="{{albumsNum}}">
        <div class="refresh"><span>下接刷新</span>

            <div class="refresh-icon"></div>
        </div>
        <div class="swiper-slide swiper-slide-v">
            {{>"ajax_explorer_box"}}
        </div>
    </div>

    <div class="loader">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <!-- Add Scroll Bar -->
    <div class="swiper-scrollbar"></div>
</div>
<script>
/*    var srwidth = document.querySelector('.swiper-wrapper').offsetWidth;
    var imgs = document.querySelectorAll('.box img');
    var boxs = document.querySelectorAll('.box');
    for (var i = 0; i < imgs.length; i++) {
        var img = imgs[i];
        var box = boxs[i];
        box.style.cssText = img.style.cssText = `width:${srwidth/3}px;height:${srwidth/3}px`;
    }*/


    Image.prototype.load = function (url, boximg, callback) {
        var thisImg = this;
        var xmlHTTP = new XMLHttpRequest();
        xmlHTTP.open('GET', url, true);
        xmlHTTP.responseType = 'arraybuffer';
        boximg.nextElementSibling.innerHTML = '0%';
        xmlHTTP.onload = function (e) {
            var blob = new Blob([this.response]);
            boximg.style['backgroundImage']  =`url(${window.URL.createObjectURL(blob)})`; //window.URL.createObjectURL(blob);
            boximg.setAttribute('class', 'swiper-lazyed');
        };
        xmlHTTP.onprogress = function (e) {
            thisImg.completedPercentage = parseInt((e.loaded / e.total) * 100);
            boximg.nextElementSibling.innerHTML = thisImg.completedPercentage + '%';
        };
        xmlHTTP.onloadstart = function () {
            thisImg.completedPercentage = 0;
            boximg.nextElementSibling.innerHTML = thisImg.completedPercentage + '%';
        };
        xmlHTTP.onloadend = function () {
            thisImg.completedPercentage = 100;
            boximg.nextElementSibling.style.display = "none"
        }
        xmlHTTP.send();
    };

    initImg();
    function initImg() {
        var swiperLazy = document.querySelectorAll('.lazy');
        for (var m = 0; m < swiperLazy.length; m++) {
            var url = swiperLazy[m].getAttribute('data-src');
            new Image().load(url, swiperLazy[m]);
        }
    }


</script>
{{#extend "mScripts"}}
    <script src="{{static}}common/js/zepto.min.js"></script>
    <script src="{{static}}mobile/js/swiper.min.js"></script>
    <script>
        //坚滚动
        var swiperV = new Swiper('.swiper-container-v', {
            scrollbar: '.swiper-scrollbar',
            direction: 'vertical',
            slidesPerView: 'auto',
            autoHeight: true,
            preloadImages: false,
            watchSlidesProgress: true,
            mousewheelControl: true,
            freeMode: true,
            // lazyLoading: true,
            onTouchStart: function (swipper) {
                swipper.setWrapperTranslate(swipper.getWrapperTranslate());
                swipper.update();
                swipper.container.data('onTouchEnd', 'false');
            },
            onTouchEnd: function (swipper) {
                var pullDistance = swipper.getWrapperTranslate();
                var realyDistance = pullDistance / window.devicePixelRatio;
                swipper.container.data('onTouchEnd', 'true');
                if (realyDistance > 50) {
                    window.setTimeout(function () {
                        swipper.container.find('.refresh span').html('正在加载中');
                    }, 10);

                    //刷新
                    swipper.container.find('.refresh-icon').addClass('anim');
                    var updateCreatedOn = swipper.container.find('.box').eq(0).attr('createdOn') || 0;
                    var url = '/m/explorer?q=update&createdOn=' + updateCreatedOn;
                    getajax(url, swipper, pullDistance)
                } else {
                    swipper.container.find('.refresh').css({
                        "z-index": 1,
                        transition: '400ms',
                        transform: "translate3d(0px,-1rem,0px)"
                    });
                    swipper.container.find('.refresh-icon').css({
                        transition: '400ms',
                        transform: "rotate(-360deg)"
                    });
                }

            },
            onProgress: function (swipper, progess) {
                var diff = swipper.touches.diff;
                var itemLength = swipper.container.find('.box').length;
                var count = swipper.wrapper.attr('count');
                var loaded = itemLength < count;
                var moreCreatedOn = swipper.container.find('.box').eq(itemLength - 1).attr('createdOn');
                var ajax = swipper.wrapper.attr('ajax');
                var pullDistance = swipper.getWrapperTranslate();
                var realyDistance = pullDistance / window.devicePixelRatio;
                if (ajax == 'false' && loaded) {
                    swipper.container.find('.loader').css('display', 'block');
                }

                if (itemLength >= count) {
                    swipper.container.find('.loader').css({
                        'left': '0',
                        'display': 'block',
                        'width': '100%'
                    }).html('没有更多的数据了');
                }
                if (realyDistance > 50) {
                    swipper.container.find('.refresh span').html('松开刷新');
                }
                if (realyDistance > 0 && realyDistance < 50) {
                    swipper.container.find('.refresh span').html('下拉刷新');
                }
                if (realyDistance > 0 && swipper.container.data('onTouchEnd') == "false") {
                    var transformY = pullDistance * 1.3;
                    if (realyDistance > 50) {
                        var transformY = 60 * window.devicePixelRatio;
                    }
                    swipper.container.find('.refresh').css({
                        "z-index": 2,
                        transition: '0ms',
                        transform: "translate3d(0," + transformY + "px,0)"
                    });
                    swipper.container.find('.refresh-icon').css({
                        transform: "rotate(" + (pullDistance * 15) + "deg)"
                    });
                }

                if (progess >= 1 && diff < 0 && ajax == 'true' && loaded) {
                    swipper.wrapper.attr('ajax', 'false');
                    var url = '/m/explorer?q=more&createdOn=' + moreCreatedOn;
                    getajax(url, swipper, diff)
                }

            }
        });
        //请求新的图片
        function getajax(url, swipper, diff) {
            $.ajax({
                type: 'get',
                url: url,
                catch: false,
                /*dataType: 'json',*/
                timeout: 10 * 1000,
                success: function (data) {
                    setitem(data, swipper, diff);
                },
                error: function (xhr, type) {

                },
                complete: function () {
                    if (diff < 0) {
                        //加载更多
                        swipper.wrapper.attr('ajax', 'true');
                        swipper.container.find('.loader').css('display', 'none');
                    } else {
                        swipper.container.find('.refresh').css({
                            "z-index": 1,
                            transition: '400ms',
                            transform: "translate3d(0,-1rem,0)"
                        });
                        swipper.container.find('.refresh-icon').removeClass('anim').css({
                            transition: '400ms',
                            transform: "rotate(0deg)"
                        });

                        swipper.setWrapperTranslate(0);
                        swipper.setWrapperTransition(300);
                    }
                }
            });
        }
        //设置新的图片
        function setitem(taove, swipper, diff) {
            if (diff < 0) {
                //加载更多
                swipper.slides.append(taove);
            } else {
                //刷新
                swipper.wrapper.attr('createdOn', taove.count);
                swipper.slides.prepend(taove);
            }

           /* $('.box').find('img').each(function () {
                var This = $(this);
                This.css({
                    width: srwidth/3,
                    height: srwidth/3
                })
            });*/
            initImg();
            swipper.update();
        }


    </script>
{{/extend}}